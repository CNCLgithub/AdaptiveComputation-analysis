---
title: "Exp 1"
output:
  pdf_document: default
  html_document:
    df_print: paged
header-includes:
 \usepackage{booktabs}
 \usepackage{longtable}
 \usepackage{array}
 \usepackage{multirow}
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
---

# Setup

```{r global-options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', 
                      echo=FALSE, warning=FALSE, message=FALSE)

```
```{r , include=FALSE}
library(tidyverse)
library(estimatr)
library(ggplot2)
library(readr)

th <- theme_classic()
theme_set(th)
```

load data (subject, exp, scenes)

```{r echo=TRUE}
# when running debug trials
subject_data <- read_csv("data/parsed_trials.csv") %>%
  separate(TrialName, c("scene", "tracker", NA, "epoch", "probe_gt", "target_gt")) %>%
  mutate(scene = as.numeric(scene),
       tracker = as.numeric(tracker),
         epoch = as.numeric(epoch),
       target_gt = target_gt == "trg",
         probe_gt = probe_gt == "probe",
         td_correct = Target == target_gt,
         probe_correct = Probe == probe_gt)


exp_data <- read_csv("data/exp0_probe_map.csv") %>%
  separate(epoch, c(NA, "epoch")) %>%
  mutate(epoch = as.numeric(epoch))

```



screen bad subjects


```{r}
good_subjects_ids <- subject_data %>%
  group_by(ID) %>%
  summarise(td_acc = mean(td_correct),
            n = n(),
            td_se = sd(td_correct)/sqrt(n),
            passed_td = (td_acc - 2.0*td_se) > 0.5,
            probe_acc = mean(probe_correct),
            probe_se = sd(probe_correct)/sqrt(n),
            passed_pb = (probe_acc - 2.0*probe_se) > 0.5,
            passed = passed_td & passed_pb) %>%
  filter(passed)

good_subjects_data <- subject_data %>%
  filter(ID %in% good_subjects_ids$ID)

print(good_subjects_ids)
```

## Analysis


Average subject performance by trial
```{r}
across_subjects <- good_subjects_data %>%
  group_by(scene, tracker, epoch, probe_gt, target_gt) %>%
  summarise(avg_td_acc = mean(td_correct),
            avg_pb = mean(probe_correct)) %>%
  ungroup() %>%
  group_by(scene, tracker, epoch) %>%
  summarise(td_acc = mean(avg_td_acc),
            pb_rate = mean(avg_pb))
```

Merge human performance with trial data (trial data = spring, sigma, attention ...)

```{r}
ns = nrow(across_subjects)
full_data <- left_join(across_subjects, exp_data, 
                       by = c("scene", "tracker", "epoch")) %>%
  ungroup() %>%
  mutate(att_rank = rank(att),
         att_qrtl = factor(ceiling(att_rank * 4 / ns)))
```

### Exploratory Visualization


```{r}
# full_data %>%
# ggplot(aes(x = epoch, y = pb_rate, color = factor(tracker))) + 
#   geom_line() +
#   facet_wrap(vars(scene)) + 
# ggtitle("Probe accuracy vs Att within scene")
```

```{r}
full_data %>%
  ggplot(aes(pb_rate, fill = att_qrtl)) + 
  geom_density() +
  scale_x_continuous(limits = c(0., 1.0)) +
  facet_wrap(vars(att_qrtl)) +
  ggtitle("Probe accuracy distribution within quartiles")
```
```{r}
good_subjects_data %>%
  ungroup() %>%
  separate(ID, c(NA, "ID")) %>%
  inner_join(full_data) %>%
  group_by(ID,scene,tracker,epoch) %>%
  summarise(pb_rate = mean(probe_correct),
            att_qrtl = first(att_qrtl)) %>%
  ggplot(aes(att_qrtl, pb_rate)) + 
  geom_violin() +
  facet_wrap(vars(ID)) +
  ggtitle("Probe accuracy distribution within subject x quartiles")

```


Measure effect of probe design on subject probe detection

```{r echo = TRUE}

full_data %>%
  filter(att_qrtl %in% c(1,4)) %>%
  group_by(att_qrtl) %>%
  summarise(mu = mean(pb_rate),
            se = sd(pb_rate) / sqrt(n())) 

human_pd_by_design <- full_data %>%
  # filter(att_qrtl %in% c(1,4)) %>%
  mutate(high_att = as.numeric(att_qrtl) > 2) %>%
  lm_robust(pb_rate ~ high_att, data = .)
summary(human_pd_by_design)
```


```{r echo = TRUE}

fits <- full_data %>%
  nest_by(scene, tracker) %>%
  mutate(mod = list(lm_robust(pb_rate ~ att,
                      data = data)))
fits %>%
  summarise(broom::tidy(mod)) %>%
  filter(term == "att") %>%
  select(-term) %>%
  rename(coeff = estimate) %>%
  ggplot(aes(factor(tracker), coeff)) +
  geom_col() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  facet_wrap(vars(scene)) + 
  ggtitle("Correlation of probe accuracy ~ attention")
```