---
title: "Exp 1"
output:
  pdf_document: default
  html_document:
    df_print: paged
header-includes:
 \usepackage{booktabs}
 \usepackage{longtable}
 \usepackage{array}
 \usepackage{multirow}
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
---

# Setup

```{r global-options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', 
                      echo=TRUE, warning=FALSE, message=FALSE)

```
```{r , include=FALSE}
library(tidyverse)
library(estimatr)
library(hexbin)
library(ggplot2)
library(readr)

th <- theme_classic()
theme_set(th)
```

load data (subject, exp, scenes)

```{r echo=TRUE}
subject_data <- read_csv("data/parsed_trials.csv") %>%
  select(-c(WID))

exp_data <- read_csv("output/isr_inertia_probe_map.csv") %>%
  group_by(scene) %>%
  mutate(epoch = dense_rank(frame)) %>%
  ungroup()

ns = nrow(exp_data)
exp_data <- exp_data %>%
  mutate(log_att = log(att),
         att_rank = rank(att),
         att_qtl = factor(ceiling(att_rank * 4 / ns))) %>%
  group_by(scene, epoch) %>%
  mutate(att_norm = att / sum(att),
         att_norm_qtl = case_when(between(att_norm, 0, 0.25) ~ 1,
                                  between(att_norm, 0.25, 0.50) ~ 2,
                                  between(att_norm, 0.50, 0.75) ~ 3,
                                  TRUE ~ 4)) %>%
  ungroup() %>%
  mutate(att_scored = zatt,
         att_pct = pnorm(att_scored),
         att_scored_qtl = case_when(between(att_pct, 0, 0.25) ~ 1,
                                    between(att_pct, 0.25, 0.50) ~ 2,
                                    between(att_pct, 0.50, 0.75) ~ 3,
                                  TRUE ~ 4)) %>%
  mutate(att_scored_qtl = factor(att_scored_qtl, levels = c(1,2,3,4)),
         att_norm_qtl = factor(att_norm_qtl, levels = c(1,2,3,4)))

```



screen bad subjects


```{r echo=TRUE}

perf_thresh = 2.0
subject_performance <- subject_data %>%
  group_by(ID) %>%
  summarise(td_acc_mu = mean(td_acc),
            pbhr = mean(pbh),
            pbfp = mean(probe_fp),
            n = n(),
            pbh_se = sd(pbh)/sqrt(n),
            td_acc_se = sd(td_acc)/sqrt(n/3),
          passed = abs(td_acc_mu - 0.5) > perf_thresh*td_acc_se & pbhr > 0)

good_subjects_data <- subject_performance %>%
  group_by(ID) %>% 
  filter(passed) %>%
  left_join(subject_data)
```

## Analysis



### Causal effects

First collect all data points (no averaging across scene)

The the average treatment effect, ATE, is indentified over attention on probe detection
regardless of target designation accuracy.

The condititional average treatement effect, CATE, is the ATE conditioned on
correct (4/4) target designation.

```{r}

ate_data <- good_subjects_data %>%
  left_join(exp_data)
  # mutate(zcrowding = scale(cumulative_dist)) %>%

# the conditional average treatment effect, conditioned on correct TD
cate_data <- ate_data %>%
  filter(td_acc == 1)

```


sanity checks on data, ensuring that each subject had the same set of trials

```{r}
ate_data %>%
  ggplot(aes(att)) + 
  geom_histogram(aes()) +
  facet_wrap(vars(ID))

```
```{r}

exp_data %>%
  ggplot(aes(att)) + 
  geom_histogram(aes(fill = att_scored_qtl))

```


The $ATE$ and $CATE$ across subjects at the qtl level
```{r}
ate_data %>%
  ungroup() %>%
  group_by(att_scored_qtl) %>%
  summarise(hr = mean(pbh),
            fp = mean(pbfp),
            d.prime = hr - fp,
            se = sd(pbh) / sqrt(n()),
            n = n()) 

cate_data %>%
  ungroup() %>%
  group_by(att_scored_qtl) %>%
  summarise(hr = mean(pbh),
            fp = mean(pbfp),
            d.prime = hr - fp,
            se = sd(pbh) / sqrt(n()),
            n = n())  
```

The $ATE$ across subjects for a given scene, epoch pair.

```{r}
ate_across_subjects <- ate_data %>%
  group_by(scene, frame) %>%
  summarise(att_scored = first(att_scored),
            n = n(),
            pbh_mu = mean(pbh),
            pbfp_mu = mean(pbfp),
            d.prime = pbh_mu - pbfp_mu,
            pbh_se = sd(pbh) / sqrt(n))

ate_across_subjects %>%
  ggplot(aes(x = att_scored, y = d.prime)) +
  geom_hex()
```

The $cate$ across subjects for a given scene, epoch pair.

```{r}
cate_across_subjects <- cate_data %>%
  group_by(scene, frame) %>%
  summarise(att_scored = first(att_scored),
            n = n(),
            pbh_mu = mean(pbh),
            pbfp_mu = mean(pbfp),
            d.prime = pbh_mu - pbfp_mu,
            pbh_se = sd(pbh) / sqrt(n))

cate_across_subjects %>%
  ggplot(aes(x = att_scored, y = d.prime)) +
  geom_hex()
```


within subject $ATE$ across qtls

```{r}
ate_data %>%
  ungroup() %>%
  group_by(ID, att_qtl) %>%
  summarise(mu = mean(pbh),
            se = sd(pbh) / sqrt(n()),
            n = n()) 

```

within subject $CATE$ across qtls


```{r}
cate_data %>%
  ungroup() %>%
  group_by(ID, att_qtl) %>%
  summarise(mu = mean(pbh),
            se = sd(pbh) / sqrt(n()),
            n = n()) 

```

The $ATE$ of attention on probe hit rate with scene and subject level fixed effects

```{r}
human_pd_by_design <- ate_data %>%
  lm_robust(pbh ~ att_scored, fixed_effects = ~ scene + ID, data = .)
  # lm_robust(pr ~ att_scored + tracker_to_origin, fixed_effects = ~ scene, data = .)
summary(human_pd_by_design)
```


The $CATE$ of attention on probe hit rate with scene and subject level fixed effects

```{r}
human_pd_by_design <- cate_data %>%
  lm_robust(pbh ~ att_scored, fixed_effects = ~ scene + ID, data = .)
  # lm_robust(pr ~ att_scored + tracker_to_origin, fixed_effects = ~ scene, data = .)
summary(human_pd_by_design)
```



<!-- ```{r} -->
<!-- # human_pd_by_design <- ate_data %>% -->
<!-- #   iv_robust(pbh ~ att_scored | zcrowding,  data = .) -->
<!-- # summary(human_pd_by_design) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- # crowd_to_att <- with(cate_data, -->
<!-- #                      lm_robust(att_scored ~ zcrowding)) -->
<!-- # crowd_to_pr <- with(cate_data, -->
<!-- #                lm_robust(pr ~ zcrowding)) -->
<!-- # summary(crowd_to_att) -->
<!-- # summary(crowd_to_pr) -->
<!-- # cate_data$res_att = cate_data$att_scored - crowd_to_att$fitted.values -->
<!-- # cate_data$res_pr = cate_data$pr - crowd_to_att$fitted.values -->
<!-- #  -->
<!-- # res_att_to_pr <- with(cate_data, -->
<!-- #                       lm_robust(res_pr ~ res_att)) -->
<!-- # summary(res_att_to_pr) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- # fits <- cate_data %>% -->
<!-- #   ungroup() %>% -->
<!-- #   nest_by(scene, tracker) %>% -->
<!-- #   mutate(mod = list(glm(pr ~ att, family = binomial(), data = data))) -->
<!-- #   # mutate(mod = list(lm_robust(pr ~ att, data = data))) -->
<!-- #  -->
<!-- # fits %>% -->
<!-- #   summarise(broom::tidy(mod)) %>% -->
<!-- #   filter(term == "att") %>% -->
<!-- #   mutate(conf.low = estimate - 1.92*std.error,  -->
<!-- #          conf.high = estimate + 1.92*std.error) %>% -->
<!-- #   select(-term) %>% -->
<!-- #   rename(coeff = estimate) %>% -->
<!-- #   ggplot(aes(factor(tracker), coeff)) + -->
<!-- #   geom_hline(yintercept = 0) + -->
<!-- #   # ylim(-4,4) + -->
<!-- #   geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + -->
<!-- #   facet_wrap(vars(scene)) + -->
<!-- #   ggtitle("Correlation of probe accuracy ~ attention") -->
<!-- ``` -->