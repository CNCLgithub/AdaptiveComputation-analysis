---
title: "Exp 1"
output:
  pdf_document: default
  html_document:
    df_print: paged
header-includes:
 \usepackage{booktabs}
 \usepackage{longtable}
 \usepackage{array}
 \usepackage{multirow}
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
---

# Setup

```{r global-options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', 
                      echo=TRUE, warning=FALSE, message=FALSE)

```
```{r , include=FALSE}
library(tidyverse)
library(estimatr)
library(hexbin)
library(ggplot2)
library(readr)

th <- theme_classic()
theme_set(th)
```

load data (subject, exp, scenes)


## Model and Design data

> TODO: look at mode of predicted assignment

Loading non-subject data 

```{r echo=FALSE, results='hide'}

# scene, frame, tracker
probe_timings <- read_csv("output/isr_inertia_480_probe_timings.csv") %>%
  mutate(probe = frame)

# scene, frame, tracker, eccentricity...
ecc_data <- read_csv("output/isr_inertia_480_probe_map_eccentricity.csv")

# scene, frame, tracker, attention, prediction location ...
inf_data <- read_csv("data/isr_inertia_480_target_designation.csv") %>%
  group_by(scene, frame, tracker) %>%
  summarise(across(-c(pred_target, prob_target, chain, particle),
                   list(mu = mean, sd = sd))) %>%
  ungroup() %>%
  mutate(zatt = scale(attention_mu),
         log_att = log(attention_mu))

```

```{r results='hide'}

# normalize distance to nearest distractor and distance to tracker centroid
ecc_data <- ecc_data %>%
  rename(tttm = tracker_to_tracker_mean) %>%
  mutate(dist_to_nd = scale(dist_to_nd),
         log_tttm = log(tttm)) %>%
  # add epochs
  group_by(scene) %>%
  mutate(epoch = dense_rank(frame)) %>% 
  ungroup()

# add lag and lead att values
# also add cumulative att
inf_data <- inf_data %>%
  group_by(scene, tracker) %>%
  mutate(across(contains("att"), list(lag = ~lag(.x, 10))),
         across(!contains("lag")  & contains("att"), list(lead = ~lead(.x, 10))),
         cum_att = cumsum(attention_mu),
         cum_zatt = cumsum(zatt)/frame,
         zatt_and_lag = zatt + zatt_lag) %>%
  # add attention quartiles 
  mutate(att_pct = pnorm(zatt),
         att_scored_qtl = case_when(between(att_pct, 0, 0.25) ~ 1,
                                    between(att_pct, 0.25, 0.50) ~ 2,
                                    between(att_pct, 0.50, 0.75) ~ 3,
                                    TRUE ~ 4)) %>%
  mutate(att_scored_qtl = factor(att_scored_qtl, levels = c(1,2,3,4)),
         high_att = att_scored_qtl == 4) %>%
  ungroup()

# sum up the total amount of attention
# and computed weighted tracker centroids
tau = 10
total_att <- inf_data %>%
  group_by(scene, frame) %>%
  summarise(total_att = sum(attention_mu),
            total_exp_att = sum(exp(attention_mu / tau)),
            weighted_x = sum(pred_x_mu * exp(attention_mu / tau) / total_exp_att),
            weighted_y = sum(pred_y_mu * exp(attention_mu / tau) / total_exp_att)) %>%
  ungroup()

# add distance to weighted and unweighted tracker means
inf_data <- inf_data %>%
  left_join(total_att, by = c("scene", "frame")) %>%
  mutate(ttwm = sqrt((weighted_x - pred_x_mu)^2 + (weighted_y - pred_y_mu)^2),
         log_ttwm = log(ttwm)) %>%
  # add ranking variable
  group_by(scene) %>%
  mutate(ttwm_rank = rank(ttwm)) %>%
  ungroup()

exp_data <- ecc_data %>%
  left_join(inf_data, by = c("scene", "frame", "tracker"))
```

## Subject Data

screen bad subjects


```{r echo=TRUE, results='hide'}
subject_data <- read_csv("data/parsed_trials.csv") %>%
  select(-c(WID))

perf_thresh =  2.0
subject_performance <- subject_data %>%
  group_by(ID) %>%
  summarise(td_acc_mu = mean(td_acc),
            pbhr = mean(pbh),
            pbfp = mean(probe_fp),
            d.prime = qnorm(pbhr) - qnorm(pbfp),
            n = n(),
            pbh_se = sd(pbh)/sqrt(n),
            td_acc_se = sd(td_acc)/sqrt(n/3),
            passed = abs(td_acc_mu - 0.5) > perf_thresh*td_acc_se & d.prime > 0) %>%
  ungroup()

good_subjects_data <- subject_performance %>%
  filter(passed) %>%
  select(ID) %>%
  left_join(subject_data, by = "ID") %>%
  ungroup()
```

# Analysis



## Causal effects

First collect all data points (no averaging across scene)

The the average treatment effect, ATE, is indentified over attention on probe detection
regardless of target designation accuracy.

The condititional average treatement effect, CATE, is the ATE conditioned on
correct (4/4) target designation.

```{r}

ate_data <- good_subjects_data %>%
  left_join(exp_data, by = c("scene", "frame", "tracker"))

# the conditional average treatment effect, conditioned on correct TD
cate_data <- ate_data %>%
  filter(td_probe)

```


```{r}
ate_across_subjects <- good_subjects_data %>%
  group_by(scene, frame, tracker) %>%
  summarise(n = n(),
            trial_order = mean(TrialOrder) / 40,
            td_acc_mu = mean(td_acc),
            td_probe_mu = mean(td_probe),
            td_probe_se = sd(td_probe) / sqrt(n),
            pbh_mu = mean(pbh) * 0.999 + 0.0001,
            pbh_se = sd(pbh) / sqrt(n),
            pbfp_mu = mean(probe_fp) * 0.999 + 0.0001,
            d.prime = qnorm(pbh_mu) - qnorm(pbfp_mu)) %>%
  ungroup() %>%
  left_join(exp_data) %>%
  group_by(scene) %>%
  mutate(ttwm_rank = rank(ttwm),
         d.prime.rank = rank(d.prime)) %>%
  ungroup()

```


sanity checks on data, ensuring that each subject had the same set of trials

```{r}
ate_data %>%
  ggplot(aes(zatt)) + 
  geom_histogram(aes()) +
  facet_wrap(vars(ID))

```


```{r}

ate_data %>%
  group_by(ID, scene) %>%
  summarise(trial_order = first(TrialOrder),
            d.prime = qnorm(mean(pbh)*0.999) - qnorm(mean(probe_fp)+0.001)) %>%
  ungroup() %>%
  ggplot(aes(x = scene, y = d.prime)) +
  geom_point() +
  facet_wrap(vars(ID))

```
```{r}

exp_data %>%
  ggplot(aes(zatt)) + 
  geom_histogram(aes(fill = att_scored_qtl))

```

## Sanity checks for scene level variation

```{r}

ate_across_subjects %>%
  ggplot(aes(d.prime, fill = factor(scene))) +
  geom_histogram() +
  guides(color = FALSE)

cum_att <- inf_data %>%
  group_by(scene) %>%
  filter(frame == max(frame)) %>%
  summarize(final_catt = sum(cum_att)) %>%
  select(c(scene, final_catt)) %>%
  right_join(ate_across_subjects, by = "scene") %>%
  mutate(final_catt = scale(final_catt))

cum_att %>%
  group_by(scene) %>%
  summarise(d.prime_mu = mean(d.prime),
            d.prime_sd = sd(d.prime),
            total_att = first(final_catt),
            p_is_target_mu = first(p_is_target_mu),
            trial_order = first(trial_order),
            ) %>%
  arrange(d.prime_mu) %>%
  ggplot(aes(y = d.prime_mu, x =reorder(scene, d.prime_mu))) +
  geom_point() +
  geom_errorbar(aes(ymin = d.prime_mu - d.prime_sd, ymax = d.prime_mu + d.prime_sd)) +
  geom_point(aes(y = trial_order * 2.5, color = "trial_order"))
```

Looking at trial order

```{r}
good_subjects_data %>%
  filter(pbh) %>%
  ggplot(aes(x = TrialOrder)) +
  geom_bar() +
  facet_grid(rows = vars(ID))

good_subjects_data %>%
  group_by(TrialOrder) %>%
  summarise(probe_fp = mean(probe_fp),
            d.prime = qnorm(mean(pbh) * 0.998 + 0.001) - qnorm(probe_fp*0.998 + 0.001)) %>%
  ggplot(aes(x = TrialOrder, y = d.prime)) +
  geom_col()

```


Focusing on specific scene

```{r}
spec_scene = c(7,11,15)

ate_across_subjects %>%
  filter(scene %in% spec_scene) %>% 
  select(scene, frame, tracker, ttwm, d.prime, pbh_se)

inf_data %>% 
  left_join(probe_timings) %>%
  filter(scene %in% spec_scene) %>% 
  ggplot(aes(x = frame, y = ttwm, color = factor(tracker), xintercept = probe)) +
  geom_vline(aes(xintercept = probe)) + 
  geom_point() +
  facet_grid(rows = vars(scene))

ate_across_subjects %>%
  filter(between(scene, 1, 20)) %>%
  ggplot(aes(x = factor(scene), y = d.prime)) +
  geom_violin()
```


## Effect of weighted tracker centroid


```{r}

ate_across_subjects %>%
  ggplot(aes(x = ttwm, y = tttm)) +
  geom_point(aes(color = zatt))


ate_across_subjects %>%
  ggplot(aes(x = tttm, y = d.prime)) +
  geom_point(aes(color = zatt))

ate_across_subjects %>%
  ggplot(aes(x = ttwm, y = d.prime)) +
  geom_point(aes(color = high_att))

ate_across_subjects %>%
  group_by(scene) %>%
  mutate(tttm_rank = rank(tttm),
         d.prime.rank = rank(d.prime)) %>%
  ggplot(aes(x = factor(tttm_rank), y = d.prime.rank)) +
  geom_violin()

ate_across_subjects %>%
  group_by(scene) %>%
  mutate(ttwm_rank = rank(ttwm),
         d.prime.rank = rank(d.prime)) %>%
  ggplot(aes(x = factor(ttwm_rank), y = d.prime.rank)) +
  geom_violin()

ate_across_subjects %>%
  group_by(scene) %>%
  mutate(ttwm_rank = rank(ttwm)) %>%
  ggplot(aes(x = factor(ttwm_rank), y = d.prime)) +
  geom_violin()

ate_data %>%
  group_by(scene, ID) %>%
  mutate(ttwm_rank = rank(ttwm)) %>%
  filter(pbh) %>%
  ggplot(aes(x = factor(ttwm_rank))) +
  geom_bar()
```

First take a look at just the tracker centroid mean

```{r}

wtm_fit <- ate_across_subjects %>%
  with(lm_robust(d.prime ~ ttwm, fixed_effects = ~ scene))
wtm_fit %>%
  summary()

ttm_fit <- ate_across_subjects %>%
  with(lm_robust(d.prime ~ tttm, fixed_effects = ~ scene))
ttm_fit %>%
  summary()


```

now look at the distance to the attention weighted tracker centroid

```{r}

high_att_acs <- ate_across_subjects

wtc_fit <- high_att_acs %>%
  with(iv_robust(d.prime ~ ttwm | tttm,
                 fixed_effects = ~ scene
                 ))
wtc_fit %>%
  summary()

high_att_acs %>%
  ggplot(aes(x = ttwm, y = d.prime)) +
  geom_point(aes(color = tttm))

high_att_acs$pred <- wtc_fit %>%
  predict(high_att_acs)

high_att_acs <- high_att_acs %>%
  mutate(resid = d.prime - pred)

high_att_acs %>%
  ggplot(aes(x = pred, y = d.prime, color = tttm)) +
  geom_point()


high_att_acs %>%
  ggplot(aes(x = resid)) +
  geom_histogram()

```


```{r}

tttm_ttwm <- ate_across_subjects %>%
  with(lm_robust(ttwm ~ tttm, fixed_effects = ~ scene))
tttm_ttwm %>%
  summary()

ate_across_subjects$pred_ttwm <- tttm_ttwm %>%
  predict(ate_across_subjects)

tttm_d.prime <- ate_across_subjects %>%
  with(lm_robust(d.prime ~ tttm, fixed_effects = ~ scene))

tttm_d.prime %>%
  summary()


ate_across_subjects$pred_d.prime <- tttm_d.prime %>%
  predict(ate_across_subjects)

ate_across_subjects <- ate_across_subjects %>%
  mutate(res_ttwm = ttwm - pred_ttwm,
         res_d.prime = d.prime - pred_d.prime)


res_res_fit <- ate_across_subjects %>%
  with(lm_robust(res_d.prime ~ res_ttwm, fixed_effects = ~ scene))
res_res_fit %>% 
  summary()

ate_across_subjects %>%
  ggplot(aes(x = res_ttwm, y = res_d.prime)) +
  geom_point(aes(color = high_att)) + 
  geom_smooth(method = "lm")
```

```{r}

high_att_acs <- ate_across_subjects

wtc_fit <- high_att_acs %>%
  with(iv_robust(d.prime ~ tttm | ttwm,
                 fixed_effects = ~ scene))
wtc_fit %>%
  summary()

high_att_acs %>%
  ggplot(aes(x = tttm, y = d.prime)) +
  geom_point(aes(color = ttwm))

high_att_acs$pred <- wtc_fit %>%
  predict(high_att_acs)

high_att_acs <- high_att_acs %>%
  mutate(resid = d.prime - pred)

high_att_acs %>%
  ggplot(aes(x = pred, y = d.prime, color = ttwm)) +
  geom_point()


high_att_acs %>%
  ggplot(aes(x = resid)) +
  geom_histogram()

```


<!-- ## Across Scenes -->

<!-- Each scene consisted of 4 probes. -->

<!-- The $ATE$ and $CATE$ across subjects at the qtl level -->
<!-- ```{r} -->
<!-- ate_data %>% -->
<!--   ungroup() %>% -->
<!--   group_by(high_att) %>% -->
<!--   summarise(hr = mean(pbh), -->
<!--             fp = mean(probe_fp), -->
<!--             d.prime = qnorm(hr) - qnorm(fp), -->
<!--             se = sd(pbh) / sqrt(n()), -->
<!--             n = n()) -->

<!-- cate_data %>% -->
<!--   ungroup() %>% -->
<!--   group_by(high_att) %>% -->
<!--   summarise(hr = mean(pbh), -->
<!--             fp = mean(probe_fp), -->
<!--             d.prime = qnorm(hr) - qnorm(fp), -->
<!--             se = sd(pbh) / sqrt(n()), -->
<!--             n = n()) -->


<!-- gen_design <- function(x, y) { -->
<!--   rest =  "+ tracker_to_tracker_mean | zcrowding + dist_to_nd + tracker_to_tracker_mean" -->
<!--   form <- as.formula(paste(y, "~", x, rest)) -->
<!--   return(form) -->
<!-- } -->

<!-- high_att_design <- gen_design("high_att", "pbh") -->
<!-- zatt_design <-  gen_design("zatt", "pbh") -->

<!-- ``` -->

<!-- Regressing high (`att_qtl == 4`) vs low attention probes -->

<!-- The $ATE$ of attention on probe hit rate with scene and subject level fixed effects -->

<!-- ```{r} -->


<!-- ate_data %>% -->
<!--   iv_robust(high_att_design, fixed_effects = ~ scene , -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- ``` -->


<!-- The $CATE$ of attention on probe hit rate with scene and subject level fixed effects -->

<!-- ```{r} -->
<!-- cate_data %>% -->
<!--   iv_robust(high_att_design, fixed_effects = ~ scene + ID, -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- ``` -->

<!-- The same regressions as above except with the continuous att (z-scored) predictor -->

<!-- The $ATE$ of attention on probe hit rate with scene and subject level fixed effects -->

<!-- ```{r} -->

<!-- ate_data %>% -->
<!--   iv_robust(zatt_design, fixed_effects = ~ scene + ID, -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- ``` -->



<!-- The $CATE$ of attention on probe hit rate with scene and subject level fixed effects -->

<!-- ```{r} -->
<!-- cate_data %>% -->
<!--   iv_robust(zatt_design, fixed_effects = ~ scene + ID, -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- ``` -->

<!-- <!-- ```{r} --> -->
<!-- <!-- ate_data %>% --> -->
<!-- <!--   filter(pbh) %>% --> -->
<!-- <!--   ggplot(aes(zatt)) + --> -->
<!-- <!--   geom_histogram() +  --> -->
<!-- <!--   facet_wrap(vars(scene)) --> -->

<!-- <!-- fits <- ate_data %>% --> -->
<!-- <!--   nest_by(scene) %>% --> -->
<!-- <!--   mutate(mod = list(iv_robust(high_att_design, data = data))) %>% --> -->
<!-- <!--   summarise(broom::tidy(mod)) %>% --> -->
<!-- <!--   filter(term == "high_attTRUE") %>% --> -->
<!-- <!--   mutate(conf.low = estimate - 1.92*std.error, --> -->
<!-- <!--          conf.high = estimate + 1.92*std.error) %>% --> -->
<!-- <!--   rename(coeff = estimate) %>% --> -->
<!-- <!--   filter(p.value < 0.1) --> -->

<!-- <!-- fits %>% --> -->
<!-- <!--   ggplot(aes(coeff)) + --> -->
<!-- <!--   geom_vline(xintercept = 0) + --> -->
<!-- <!--   xlim(-1, 1) + --> -->
<!-- <!--   geom_errorbarh(aes(y = 0, xmin = conf.low, xmax = conf.high)) + --> -->
<!-- <!--   facet_wrap(vars(scene)) + --> -->
<!-- <!--   ggtitle("Correlation of d-prime ~ attention") --> -->
<!-- <!-- ``` --> -->


<!-- ## DPRIME - Within Scenes, across subjects -->

<!-- The $ATE$ across subjects for a given scene, epoch pair. -->

<!-- As of now there is probably not enough data to report any significant effects. -->

<!-- The histogram plots the distribution of effect sizes for significant scenes -->

<!-- ```{r} -->


<!-- dprime_design <- gen_design("zatt", "d.prime") -->

<!-- ate_across_subjects %>% -->
<!--   iv_robust(dprime_design, data = .) %>% -->
<!--   summary() -->

<!-- fits <- ate_across_subjects %>% -->
<!--   nest_by(scene) %>% -->
<!--   mutate(mod = list(iv_robust(dprime_design, data = data))) %>% -->
<!--   summarise(broom::tidy(mod)) %>% -->
<!--   filter(term == "zatt") %>% -->
<!--   mutate(conf.low = estimate - 1.92*std.error, -->
<!--          conf.high = estimate + 1.92*std.error) %>% -->
<!--   rename(coeff = estimate) %>% -->
<!--   filter(p.value < 0.1) -->

<!-- fits %>% -->
<!--   ggplot(aes(coeff)) + -->
<!--   geom_vline(xintercept = 0) + -->
<!--   xlim(-1, 1) + -->
<!--   geom_errorbarh(aes(y = 0, xmin = conf.low, xmax = conf.high)) + -->
<!--   facet_wrap(vars(scene)) + -->
<!--   ggtitle("Correlation of d-prime ~ attention") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- ate_across_subjects %>% -->
<!--   filter(scene == 11) %>% -->
<!--   print() -->
<!-- ``` -->

<!-- The $cate$ across subjects for a given scene, epoch pair. -->

<!-- ```{r} -->
<!-- cate_across_subjects  <- cate_data %>% -->
<!--   filter(td_probe) %>% -->
<!--   group_by(scene, frame, tracker) %>% -->
<!--   summarise(n = n(), -->
<!--             td_acc_mu = mean(td_acc), -->
<!--             td_probe_mu = mean(td_probe), -->
<!--             td_probe_se = sd(td_probe) / sqrt(n), -->
<!--             pbh_mu = mean(pbh) * 0.999 + 0.0001, -->
<!--             pbfp_mu = mean(probe_fp) * 0.999 + 0.0001, -->
<!--             d.prime = qnorm(pbh_mu) - qnorm(pbfp_mu), -->
<!--             pbh_se = sd(pbh) / sqrt(n), -->
<!--             conf.low = qnorm(pbh_mu - pbh_se) - qnorm(pbfp_mu), -->
<!--             conf.high = qnorm(pbh_mu + pbh_se) - qnorm(pbfp_mu)) %>% -->
<!--   ungroup() %>% -->
<!--   left_join(exp_data) -->


<!-- cate_across_subjects %>% -->
<!--   iv_robust(dprime_design, data = .) %>% -->
<!--   summary() -->


<!-- fits <- cate_across_subjects %>% -->
<!--   nest_by(scene) %>% -->
<!--   mutate(mod = list(iv_robust(dprime_design, data = data))) %>% -->
<!--   summarise(broom::tidy(mod)) %>% -->
<!--   filter(term == "zatt") %>% -->
<!--   mutate(conf.low = estimate - 1.92*std.error, -->
<!--          conf.high = estimate + 1.92*std.error) %>% -->
<!--   rename(coeff = estimate) %>% -->
<!--   filter(p.value < 0.05) -->

<!-- fits %>% -->
<!--   ggplot(aes(coeff)) + -->
<!--   geom_vline(xintercept = 0) + -->
<!--   xlim(-1, 1) + -->
<!--   geom_errorbarh(aes(y = 0, xmin = conf.low, xmax = conf.high)) + -->
<!--   facet_wrap(vars(scene)) + -->
<!--   ggtitle("Correlation of d-prime ~ attention") -->

<!-- ``` -->

<!-- ## DPRIME - Within subject -->



<!-- ```{r} -->
<!-- ate_within_subject <- ate_data %>% -->
<!--   ungroup() %>% -->
<!--   group_by(ID, att_scored_qtl) %>% -->
<!--   summarise(mu = mean(d.prime), -->
<!--             se = sd(d.prime) / sqrt(n()), -->
<!--             conf.low = mu - se, -->
<!--             conf.high = mu + se, -->
<!--             n = n()) %>% -->
<!--   ungroup() -->

<!-- cate_within_subject <- cate_data %>% -->
<!--   ungroup() %>% -->
<!--   group_by(ID, att_scored_qtl) %>% -->
<!--   summarise(mu = mean(d.prime), -->
<!--             se = sd(d.prime) / sqrt(n()), -->
<!--             conf.low = mu - se, -->
<!--             conf.high = mu + se, -->
<!--             se = sd(d.prime) / sqrt(n()), -->
<!--             n = n()) %>% -->
<!--   ungroup() -->



<!-- ``` -->

<!-- within subject $ATE$ across qtls -->

<!-- ```{r} -->

<!-- print(ate_within_subject) -->

<!-- ``` -->

<!-- within subject $CATE$ across qtls -->


<!-- ```{r} -->
<!-- print(cate_within_subject) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- ate_within_subject %>% -->
<!--   ggplot(aes(x = att_scored_qtl, y = mu)) + -->
<!--   # geom_col() +  -->
<!--   geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + -->
<!--   facet_wrap(vars(ID)) -->
<!-- ``` -->
<!-- ```{r} -->

<!-- cate_within_subject %>% -->
<!--   ggplot(aes(x = att_scored_qtl, y = mu)) + -->
<!--   # geom_col() +  -->
<!--   geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + -->
<!--   facet_wrap(vars(ID)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- fits <- ate_data %>% -->
<!--   nest_by(ID) %>% -->
<!--   mutate(mod = list(iv_robust(high_att_design, data = data))) -->

<!-- fits %>% -->
<!--   summarise(broom::tidy(mod)) %>% -->
<!--   filter(term == "high_attTRUE") %>% -->
<!--   mutate(conf.low = estimate - 1.92*std.error, -->
<!--          conf.high = estimate + 1.92*std.error) %>% -->
<!--   rename(coeff = estimate) %>% -->
<!--   ggplot(aes(coeff, term)) + -->
<!--   geom_vline(xintercept = 0) + -->
<!--   geom_errorbar(aes(xmin = conf.low, xmax = conf.high)) + -->
<!--   facet_wrap(vars(ID)) + -->
<!-- ggtitle("Correlation of probe hit rate ~ attention") -->
<!-- ``` -->


<!-- ```{r} -->
<!-- fits <- cate_data %>% -->
<!--   ungroup() %>% -->
<!--   nest_by(ID) %>% -->
<!--   mutate(mod = list(iv_robust(high_att_design, data = data))) -->

<!-- fits %>% -->
<!--   summarise(broom::tidy(mod)) %>% -->
<!--   filter(term == "high_attTRUE") %>% -->
<!--   mutate(conf.low = estimate - 1.92*std.error, -->
<!--          conf.high = estimate + 1.92*std.error) %>% -->
<!--   rename(coeff = estimate) %>% -->
<!--   ggplot(aes(coeff, term)) + -->
<!--   geom_vline(xintercept = 0) + -->
<!--   geom_errorbar(aes(xmin = conf.low, xmax = conf.high)) + -->
<!--   facet_wrap(vars(ID)) + -->
<!-- ggtitle("Correlation of probe hit rate ~ attention") -->
<!-- ``` -->

<!-- <!-- ## Only "good" subjects --> -->

<!-- <!-- ```{r} --> -->
<!-- <!-- best_subjects_data <-  good_subjects_data %>% --> -->
<!-- <!--   ungroup() %>% --> -->
<!-- <!--   filter(ID %in% c("Participant_7", "Participant_8", "Participant_10")) --> -->

<!-- <!--   # filter(ID %in% c("Participant_7", "Participant_8", "Participant_10")) %>% --> -->
<!-- <!--   # left_join(exp_data) --> -->


<!-- <!-- best_subjects_data %>% --> -->
<!-- <!--   ggplot(aes(x = high_att, y = pbh)) +  --> -->
<!-- <!--   geom_violin() --> -->

<!-- <!-- best_subjects_data %>% --> -->
<!-- <!--   iv_robust(zatt_design, data = .) %>% --> -->
<!-- <!--   summary() --> -->

<!-- <!-- fits <- best_subjects_data %>% --> -->
<!-- <!--   nest_by(scene) %>% --> -->
<!-- <!--   mutate(mod = list(iv_robust(zatt_design, data = data))) %>% --> -->
<!-- <!--   summarise(broom::tidy(mod)) %>% --> -->
<!-- <!--   filter(term == "zatt") %>% --> -->
<!-- <!--   mutate(conf.low = estimate - 1.92*std.error, --> -->
<!-- <!--          conf.high = estimate + 1.92*std.error) %>% --> -->
<!-- <!--   rename(coeff = estimate) --> -->


<!-- <!-- fits %>% --> -->
<!-- <!--   ggplot(aes(coeff)) + --> -->
<!-- <!--   geom_vline(xintercept = 0) + --> -->
<!-- <!--   xlim(-1, 1) + --> -->
<!-- <!--   geom_errorbarh(aes(y = 0, xmin = conf.low, xmax = conf.high)) + --> -->
<!-- <!--   facet_wrap(vars(scene)) + --> -->
<!-- <!--   ggtitle("Correlation of d-prime ~ attention") --> -->

<!-- <!-- ``` --> -->

<!-- ## Only in high attention -->

<!-- ```{r} -->

<!-- high_att_ate_data <- ate_data %>% -->
<!--   filter(att_scored_qtl == 4) -->

<!-- ``` -->

<!-- ```{r} -->

<!-- high_att_ate_data %>% -->
<!-- ggplot(aes(x = att_scored, y = prop_att)) + -->
<!--   geom_point() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- high_att_ate_design <- pbh ~ prop_att -->
<!-- high_att_ate_data %>% -->
<!--   lm_robust(high_att_ate_design, fixed_effects = ~ scene + ID, -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- high_att_ate_data %>% -->
<!--   lm_robust(zatt_design, fixed_effects = ~ scene + ID, -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- ``` -->



<!-- ## Lag and Lead analysis -->


<!-- ```{r} -->

<!-- lag_zatt_design <- gen_design("zatt_lag", "pbh") -->
<!-- lead_zatt_design <-gen_design("zatt_lead", "pbh") -->

<!-- ate_data %>% -->
<!--   lm_robust(zatt_design, fixed_effects = ~ ID + scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_data %>% -->
<!--   lm_robust(lag_zatt_design, fixed_effects = ~ ID + scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_data %>% -->
<!--   lm_robust(lead_zatt_design, fixed_effects = ~ ID + scene, -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- ``` -->

<!-- ## Cumulative attention analysis -->


<!-- ```{r} -->
<!-- cum_att_design <- pbh ~ cum_att + tracker_to_tracker_mean + prop_att |  dist_to_nd + tracker_to_tracker_mean + prop_att -->


<!-- ate_data %>% -->
<!--   lm_robust(zatt_design, fixed_effects = ~ scene + ID +tracker, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_data %>% -->
<!--   lm_robust(cum_att_design, fixed_effects = ~ ID + scene + tracker, -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- ``` -->

<!-- ```{r} -->

<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(x = zatt, y = d.prime)) + -->
<!--   geom_point() -->

<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(x = cum_zatt, y = d.prime)) + -->
<!--   geom_point() -->

<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(x = zatt_lag, y = d.prime)) + -->
<!--   geom_point() -->

<!-- ate_data <- ate_data %>% -->
<!--   group_by(scene) %>% -->
<!--   mutate(att_rank = dense_rank(att)) %>% -->
<!--   ungroup() -->
<!-- ``` -->

<!-- ```{r} -->

<!-- ate_data %>% -->
<!--   filter(pbh) %>% -->
<!--   ggplot(aes(x = as.integer(att_rank))) + -->
<!--   geom_bar() + -->
<!--   facet_wrap(vars(scene)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- ate_across_subjects %>% -->
<!--   group_by(scene) %>% -->
<!--   mutate(att_rank = dense_rank(att)) %>% -->
<!--   filter(scene == 34 | scene == 36) %>% -->
<!--   select(c(scene, frame, att_rank, tracker,d.prime, zatt, zatt_and_lag, tracker_to_origin, dist_to_nd)) %>% -->
<!--   arrange(scene, d.prime) %>% -->
<!--   print() -->

<!-- # ate_across_subjects %>% -->
<!-- #   lm_robust(d.prime ~ zatt_and_lag + tracker_to_origin,  -->
<!-- #             fixed_effects = ~ scene, -->
<!-- #             data = .) %>% -->
<!-- #   summary() -->

<!-- ``` -->


<!-- ## IV within scene analysis -->


<!-- An instrumental variables regression of sticky attention on dprime was performed where the distance to nearest distractor served as the instrument and eccentricity (distance of the tracker to the origin) was a covariate.  -->

<!-- Below, we report the regression summary along with key visualizations including the distribution of residuals and the predicted vs actual dprime relationship.  -->
<!-- ```{r} -->
<!-- # iv_fit <- ate_across_subjects %>% -->
<!-- #           iv_robust(d.prime ~ zatt_and_lag + tracker_to_origin | dist_to_nd + tracker_to_origin,  -->
<!-- #                     fixed_effects = ~ scene, -->
<!-- #                     data = .) -->


<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(x = tracker_to_tracker_mean, y = d.prime)) +  -->
<!--   geom_point(aes(color = high_att)) -->

<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(x = zatt_and_lag, y = d.prime)) +  -->
<!--   geom_point(aes(color = high_att)) -->


<!-- iv_fit <- ate_across_subjects %>% -->
<!--           iv_robust(d.prime ~  tracker_to_tracker_mean | zatt_and_lag,  -->
<!--                     fixed_effects = ~ scene, -->
<!--                     data = .) -->


<!-- iv_fit %>% -->
<!--   summary() -->

<!-- iv_fit <- ate_across_subjects %>% -->
<!--           lm_robust(d.prime ~ zatt_and_lag + tracker_to_tracker_mean,  -->
<!--                     fixed_effects = ~ scene, -->
<!--                     data = .) -->


<!-- iv_fit %>% -->
<!--   summary() -->


<!-- iv_fit <- ate_across_subjects %>% -->
<!--           lm_robust(zatt_and_lag ~ tracker_to_tracker_mean,  -->
<!--                     fixed_effects = ~ scene, -->
<!--                     data = .) -->


<!-- iv_fit %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--           lm_robust(d.prime ~ dist_to_nd + tracker_to_origin,  -->
<!--                     fixed_effects = ~ scene, -->
<!--                     data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects$d.prime.pred <- predict(iv_fit, ate_across_subjects) -->
<!-- ate_across_subjects <- ate_across_subjects %>% -->
<!--   mutate(d.prime.res = d.prime - d.prime.pred) -->

<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(x = d.prime.pred, y = d.prime, color = high_att)) + -->
<!--   geom_point() + -->
<!--   ggtitle("Predicted vs actual D'") -->

<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(d.prime.res)) + -->
<!--   geom_histogram() + -->
<!--   ggtitle("Distributio of residuals") -->


<!-- iv_fits <- ate_across_subjects %>% -->
<!--   nest_by(scene) %>% -->
<!--   mutate(mod = list(iv_robust(d.prime ~ zatt_and_lag + tracker_to_origin | dist_to_nd + tracker_to_origin,  -->
<!--                data = data))) -->


<!-- # iv_fits %>% -->
<!-- #   summarise(broom::tidy(mod)) %>% -->
<!-- #   filter(term == "zatt_and_lag") %>% -->
<!-- #   mutate(conf.low = estimate - 1.92*std.error, -->
<!-- #          conf.high = estimate + 1.92*std.error) %>% -->
<!-- #   rename(coeff = estimate) %>% -->
<!-- #   ggplot(aes(coeff, term)) + -->
<!-- #   geom_vline(xintercept = 0) + -->
<!-- #   xlim(-1, 1) + -->
<!-- #   geom_errorbar(aes(xmin = conf.low, xmax = conf.high)) + -->
<!-- #   facet_wrap(vars(scene)) + -->
<!-- # ggtitle("Correlation of probe hit rate ~ attention") -->

<!-- # ate_data %>% -->
<!-- #   iv_robust(pbh ~ zatt_and_lag + tracker_to_origin | dist_to_nd + tracker_to_origin,  -->
<!-- #             fixed_effects = ~ scene + ID, -->
<!-- #             data = .) %>% -->
<!-- #   summary() -->
<!-- ``` -->

<!-- ```{r} -->


<!-- # are these variables unrelated across attention groups? -->
<!-- ate_across_subjects %>% -->
<!--   filter(high_att) %>% -->
<!--   lm_robust(zatt_and_lag ~ tracker_to_tracker_mean,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(!high_att) %>% -->
<!--   lm_robust(zatt_and_lag ~ tracker_to_tracker_mean,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(high_att) %>% -->
<!--   iv_robust(d.prime ~ zatt_and_lag | tracker_to_tracker_mean,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(!high_att) %>% -->
<!--   iv_robust(d.prime ~ zatt_and_lag | tracker_to_tracker_mean,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(high_att) %>% -->
<!--   iv_robust(d.prime ~ tracker_to_tracker_mean | zatt_and_lag,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(!high_att) %>% -->
<!--   iv_robust(d.prime ~ tracker_to_tracker_mean | zatt_and_lag,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->


<!-- ate_across_subjects %>% -->
<!--   filter(high_att) %>% -->
<!--   lm_robust(d.prime ~ tracker_to_tracker_mean,  -->
<!--             # fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(!high_att) %>% -->
<!--   lm_robust(d.prime ~ tracker_to_tracker_mean,  -->
<!--             # fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(high_att) %>% -->
<!--   lm_robust(d.prime ~ zatt_and_lag,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(!high_att) %>% -->
<!--   lm_robust(d.prime ~ zatt_and_lag,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->


<!-- ``` -->
<!-- ```{r} -->

<!-- ate_across_subjects %>% -->
<!--   filter(high_att) %>% -->
<!--   lm_robust(d.prime ~ dist_to_nd,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->

<!-- ate_across_subjects %>% -->
<!--   filter(!high_att) %>% -->
<!--   lm_robust(d.prime ~ dist_to_nd,  -->
<!--             fixed_effects = ~ scene, -->
<!--             data = .) %>% -->
<!--   summary() -->
<!-- ``` -->


<!-- ```{r} -->

<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(y = td_acc_mu, x = d.prime)) + -->
<!--   geom_point() -->

<!-- ate_across_subjects %>% -->
<!--   ggplot(aes(d.prime)) + -->
<!--   geom_histogram() -->
<!-- ``` -->