---
title: "Exp 1"
output:
  pdf_document: default
  html_document:
    df_print: paged
header-includes:
 \usepackage{booktabs}
 \usepackage{longtable}
 \usepackage{array}
 \usepackage{multirow}
 \usepackage{wrapfig}
 \usepackage{float}
 \floatplacement{figure}{H}
---

# Setup

```{r global-options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', 
                      echo=FALSE, warning=FALSE, message=FALSE)

```
```{r , include=FALSE}
library(tidyverse)
library(estimatr)
library(ggplot2)
library(readr)

th <- theme_classic()
theme_set(th)
```

load data (subject, exp, scenes)

```{r echo=TRUE}
# when running debug trials
subject_data <- read_csv("data/parsed_trials.csv") %>%
  separate(TrialName, c("scene", "tracker", NA, "epoch", "trial_type", "gt")) %>%
  mutate(scene = as.numeric(scene),
         tracker = as.numeric(tracker),
         epoch = as.numeric(epoch),
         gt = gt == "T",
         correct = Response == gt)


exp_data <- read_csv("data/exp0_probe_map.csv") %>%
  separate(epoch, c(NA, "epoch")) %>%
  mutate(epoch = as.numeric(epoch)) %>%
  ungroup() %>%
  mutate(att_rank = rank(att),
         att_qrtl = factor(ceiling(att_rank * 4 / ns))) %>%
  group_by(scene, epoch) %>%
  mutate(att_norm = att / sum(att),
         att_scored = scale(att),
         att_pct = pnorm(att_scored),
         att_scored_qtl = case_when(between(att_pct, 0, 0.25) ~ 1,
                                    between(att_pct, 0.25, 0.50) ~ 2,
                                    between(att_pct, 0.50, 0.75) ~ 3,
                                    TRUE ~ 4)) %>%
  mutate(att_scored_qtl = factor(att_scored_qtl)) %>%
  ungroup()

```



screen bad subjects


```{r echo=TRUE}

subject_performance <- subject_data %>%
  group_by(ID, trial_type) %>%
  summarise(acc = mean(correct),
            n = n(),
            se = sd(correct)/sqrt(n),
            passed = (acc - 1.5*se) > 0.5)

good_subjects_data <-subject_performance %>%
  group_by(ID) %>%
  summarise(passed = all(passed)) %>%
  filter(passed) %>%
  left_join(subject_data)

print(subject_performance)
```

## Analysis


Average subject performance by trial
```{r}
across_subjects <- good_subjects_data %>%
  group_by(scene, tracker, epoch, trial_type) %>%
  summarise(avg_acc = mean(correct),
            n = n()) %>%
  pivot_wider(names_from = trial_type, values_from = avg_acc) %>%
  mutate(pr_abs = abs(pr - 0.5) * 2)
```

Merge human performance with trial data (trial data = spring, sigma, attention ...)

```{r}
ns = nrow(across_subjects)
full_data <- across_subjects %>%
  left_join(exp_data, by = c("scene", "tracker", "epoch"))
```

### Exploratory Visualization



```{r}
full_data %>%
ggplot(aes(x = epoch, y = att_scored, color = factor(tracker))) +
  geom_point() +
  facet_wrap(vars(scene)) +
ggtitle("Probe accuracy vs Att within scene")
```

```{r}
full_data %>%
ggplot(aes(x = att_norm, y = pr_abs, color = factor(tracker))) +
  geom_point() +
  facet_wrap(vars(scene)) +
ggtitle("Probe accuracy vs Att within scene")
```

```{r}
full_data %>%
ggplot(aes(pr, color = att_scored_qtl)) +
  geom_density() +
  facet_wrap(vars(att_scored_qtl)) +
ggtitle("Probe accuracy vs Att across scenes")
```

```{r}
full_data %>%
  ggplot(aes(x = att_scored_qtl, y = pr_abs)) +
  geom_violin() +
ggtitle("Probe accuracy vs Att across scenes")
```

```{r}
full_data %>%
  ggplot(aes(x = att_qrtl, y = pr_abs)) +
  geom_violin() +
ggtitle("Probe accuracy vs Att across scenes")
```

```{r}

per_subject <- good_subjects_data %>%
  separate(ID, c(NA, "ID")) %>%
  left_join(full_data) %>%
  group_by(ID,scene,tracker,epoch) %>%
  summarise(pr = mean(pr),
            att_qrtl = first(att_scored_qtl)) %>%
  ungroup()

per_subject %>%
  ggplot(aes(att_qrtl, pr)) + 
  geom_violin() +
  facet_wrap(vars(ID)) +
  ggtitle("Probe accuracy distribution within subject x quartiles")

```


Measure effect of probe design on subject probe detection

```{r echo = TRUE}

full_data %>%
  ungroup() %>%
  filter(att_scored_qtl %in% c(1,4)) %>%
  group_by(att_scored_qtl) %>%
  summarise(mu = mean(pr_abs),
            se = sd(pr_abs) / sqrt(n())) 

human_pd_by_design <- full_data %>%
# filter(att_scored_qtl %in% c(1,4)) %>%
  lm_robust(pr_abs ~ att_scored, data = .)
summary(human_pd_by_design)

human_pd_by_design <- full_data %>%
  lm_robust(pr_abs ~ att + att_norm, data = .)
summary(human_pd_by_design)
```


```{r echo = TRUE}

fits <- full_data %>%
  ungroup() %>%
  nest_by(scene) %>%
  mutate(mod = list(lm_robust(pr_abs ~ att_norm,
                      data = data)))

fits %>%
  summarise(broom::tidy(mod)) %>%
  filter(term == "att_norm") %>%
  select(-term) %>%
  rename(coeff = estimate) %>%
  ggplot(aes(factor(tracker), coeff)) +
  geom_col() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  facet_wrap(vars(scene)) + 
  ggtitle("Correlation of probe accuracy ~ attention")
```